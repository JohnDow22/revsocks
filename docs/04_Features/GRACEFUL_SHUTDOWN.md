# Feature: Graceful Shutdown (Signal Handler)

**–í–µ—Ä—Å–∏—è:** 2.5-graceful-shutdown  
**–î–∞—Ç–∞:** 09.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready

---

## üìå –ü—Ä–æ–±–ª–µ–º–∞

–†–∞–Ω–µ–µ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ `Ctrl+C` / `SIGTERM`:
- —á–∞—Å—Ç–∏ –≥–æ—Ä—É—Ç–∏–Ω –ø—Ä–æ–¥–æ–ª–∂–∞–ª–∏ —Ä–∞–±–æ—Ç–∞—Ç—å –¥–æ —Ç–µ—Ö –ø–æ—Ä, –ø–æ–∫–∞ –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è –ø—Ä–æ—Ü–µ—Å—Å;
- –¥–æ–ª–≥–∏–µ `time.Sleep` –∏ retry-—Ü–∏–∫–ª—ã –Ω–µ –ø—Ä–µ—Ä—ã–≤–∞–ª–∏—Å—å —Å—Ä–∞–∑—É;
- –Ω–µ –±—ã–ª–æ –µ–¥–∏–Ω–æ–≥–æ –º–µ—Ö–∞–Ω–∏–∑–º–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞/—Å–µ—Ä–≤–µ—Ä–∞ –∏ —Å–µ—Ç–µ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π.

–≠—Ç–æ —É—Å–ª–æ–∂–Ω—è–ª–æ –æ—Å—Ç–∞–Ω–æ–≤–∫—É —Å–µ—Ä–≤–∏—Å–∞, –º–æ–≥–ª–æ –æ—Å—Ç–∞–≤–ª—è—Ç—å –Ω–µ–∑–∞–∫—Ä—ã—Ç—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∏ –ø–æ—Ä–æ–∂–¥–∞—Ç—å ¬´–≥—Ä—è–∑–Ω–æ–µ¬ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ.

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–î–æ–±–∞–≤–ª–µ–Ω —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π **graceful shutdown**:
- —Ñ—É–Ω–∫—Ü–∏—è `setupSignalHandler()` —Å–æ–∑–¥–∞—ë—Ç –≥–ª–æ–±–∞–ª—å–Ω—ã–π `context.Context` –∏ `globalCancel()`;
- –ø—Ä–∏ –ø—Ä–∏—Ö–æ–¥–µ —Å–∏–≥–Ω–∞–ª–æ–≤ `SIGINT`/`SIGTERM` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `globalCancel()` –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è 2-—Å–µ–∫—É–Ω–¥–Ω—ã–π grace-period;
- –≤—Å–µ –¥–æ–ª–≥–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ (reconnect-loop, sleep, –æ–∂–∏–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–π) –ø—Ä–æ–≤–µ—Ä—è—é—Ç `globalCtx.Done()` –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤—ã—Ö–æ–¥—è—Ç.

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- `time.Sleep` –≤ reconnect-—Ü–∏–∫–ª–∞—Ö –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ `select` —Å —Ç–∞–π–º–∞—É—Ç–æ–º –∏ –ø—Ä–æ–≤–µ—Ä–∫–æ–π `ctx.Done()`;
- –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –æ–¥–∏–Ω –æ–±—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏;
- –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º –≤—ã–¥–µ–ª–µ–Ω–æ –≤—Ä–µ–º—è –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–∫—Ä—ã—Ç–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –≥–æ—Ä—É—Ç–∏–Ω.

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è ‚Äî graceful shutdown —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é.

–ü—Ä–∏–º–µ—Ä—ã:

```bash
# –ê–≥–µ–Ω—Ç
./revsocks-agent --connect server:8443 --pass test123

# –°–µ—Ä–≤–µ—Ä
./revsocks-server --listen :8443 --socks 127.0.0.1:1080 --pass test123
```

–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ:

```bash
# –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º –∏–ª–∏ –∞–≥–µ–Ω—Ç–æ–º
Ctrl+C
```

–ü–æ–≤–µ–¥–µ–Ω–∏–µ:
- –ø—Ä–∏–Ω—è—Ç —Å–∏–≥–Ω–∞–ª ‚Üí –ª–æ–≥–∏—Ä—É–µ—Ç—Å—è —Å–æ–±—ã—Ç–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏;
- –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `globalCancel()` ‚Üí –≤—Å–µ —Ü–∏–∫–ª—ã, –∑–∞–≤—è–∑–∞–Ω–Ω—ã–µ –Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≤–µ—Ä—à–∞—é—Ç—Å—è;
- —á–µ—Ä–µ–∑ ~2 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±–µ–∑ ¬´–∑–∞–≤–∏—Å—à–∏—Ö¬ª –≥–æ—Ä—É—Ç–∏–Ω.

---

## üîß –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- `setupSignalHandler()` —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `os.Signal` –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—É—é –≥–æ—Ä—É—Ç–∏–Ω—É –æ–∂–∏–¥–∞–Ω–∏—è —Å–∏–≥–Ω–∞–ª–æ–≤;
- –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç (`globalCtx`) –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤:
  - reconnect-—Ü–∏–∫–ª—ã –∞–≥–µ–Ω—Ç–∞;
  - accept-—Ü–∏–∫–ª—ã —Å–µ—Ä–≤–µ—Ä–∞ (—Ç–∞–º, –≥–¥–µ —ç—Ç–æ —É–º–µ—Å—Ç–Ω–æ);
  - –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ–æ–Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏;
- –≤–º–µ—Å—Ç–æ:

```go
time.Sleep(time.Second * N)
```

–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è:

```go
select {
case <-time.After(time.Second * N):
case <-globalCtx.Done():
    return
}
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–†—É—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- –∑–∞–ø—É—Å–∫ –∞–≥–µ–Ω—Ç–∞/—Å–µ—Ä–≤–µ—Ä–∞, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –∑–∞—Ç–µ–º `Ctrl+C`;
- —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è –±—ã—Å—Ç—Ä–æ (–±–µ–∑ –¥–æ–ª–≥–∏—Ö ¬´–≤–∏—Å—è—â–∏—Ö¬ª sleep);
- —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –Ω–µ –æ—Å—Ç–∞—é—Ç—Å—è ¬´–∑–æ–º–±–∏¬ª-–ø—Ä–æ—Ü–µ—Å—Å—ã.

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏:
- –±–∞–∑–æ–≤—ã–µ unit-—Ç–µ—Å—Ç—ã –∏ E2E-—Ç–µ—Å—Ç—ã –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ graceful shutdown –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ —Ä–µ–≥—Ä–µ—Å—Å–∏–π;
- –ø—Ä–æ–≤–µ—Ä–∫–∏ reconnect-–ª–æ–≥–∏–∫–∏ —Å —É—á—ë—Ç–æ–º —Ä–∞–Ω–Ω–µ–≥–æ –≤—ã—Ö–æ–¥–∞ –ø–æ `ctx.Done()`.

---

## üìä –°—Ç–∞—Ç—É—Å

- **–í–µ—Ä—Å–∏—è:** 2.5-graceful-shutdown  
- **–î–∞—Ç–∞:** 09.01.2026  
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready  
- **–¢–µ—Å—Ç—ã:** Unit + E2E (–æ–±—â–∏–π –ø—Ä–æ–≥–æ–Ω —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –Ω–∞–±–æ—Ä–∞ –ø–æ—Å–ª–µ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏)

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- CHANGELOG —Å–µ–∫—Ü–∏—è `2.5-graceful-shutdown`;
- –æ–±—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ reconnect- –∏ beacon-—Ü–∏–∫–ª–æ–≤: `BEACON_MODE.md`.

