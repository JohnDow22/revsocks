# Feature: Lazy TLS Certificate Caching

**–í–µ—Ä—Å–∏—è:** 2.6  
**–î–∞—Ç–∞:** 09.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready

## üìå –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∫–∞–∂–¥–æ–º –∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞ –±–µ–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (`-cert` —Ñ–ª–∞–≥) –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ–ª–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è RSA 2048 –∫–ª—é—á–µ–≤–æ–π –ø–∞—Ä—ã. –≠—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç 100-500ms, —á—Ç–æ –∑–∞–º–µ—Ç–Ω–æ –∑–∞–º–µ–¥–ª—è–µ—Ç —Å—Ç–∞—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞, –æ—Å–æ–±–µ–Ω–Ω–æ –ø—Ä–∏ —á–∞—Å—Ç—ã—Ö –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –ø—Ä–∏ –≥–æ—Ä—è—á–µ–π –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ –∏–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏–∑–∞—Ü–∏–∏).

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ –∫–µ—à–∏—Ä—É–µ—Ç—Å—è –≤ `~/.revsocks-tls-cache/server.crt` –∏ `~/.revsocks-tls-cache/server.key`. –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –∑–∞–ø—É—Å–∫–∞—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞ (~1ms –≤–º–µ—Å—Ç–æ 100-500ms).

### –ú–µ—Ö–∞–Ω–∏–∑–º —Ä–∞–±–æ—Ç—ã

1. **–ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫:**
   - –ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –∫–µ—à–∞
   - –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–æ–≤—ã–π RSA 2048 –∫–ª—é—á
   - –°–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ `~/.revsocks-tls-cache/` —Å –ø—Ä–∞–≤–∞–º–∏ 0600
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: `TLS certificate cached to /home/user/.revsocks-tls-cache`

2. **–ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏:**
   - –ó–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑ –∫–µ—à–∞ —Å –ø–æ–º–æ—â—å—é `tls.LoadX509KeyPair()`
   - –õ–æ–≥–∏—Ä—É–µ—Ç—Å—è: `Loaded cached TLS certificate from /home/user/.revsocks-tls-cache`

3. **Fallback:**
   - –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ home dir ‚Üí –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º –±–µ–∑ –∫–µ—à–∞ (log warning)
   - –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É (log warning)

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä –±–µ–∑ `-cert` —Ñ–ª–∞–≥–∞:

```bash
# –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫ (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è + –∫–µ—à)
./revsocks -listen :8443 -socks 127.0.0.1:1080 -tls
# Output: Generating new TLS certificate...
#         TLS certificate cached to /home/user/.revsocks-tls-cache

# –ü–æ–≤—Ç–æ—Ä–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ –∫–µ—à–∞)
./revsocks -listen :8443 -socks 127.0.0.1:1080 -tls
# Output: Loaded cached TLS certificate from /home/user/.revsocks-tls-cache
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–≤–æ–π —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–∫–µ—à –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è):

```bash
./revsocks -listen :8443 -socks 127.0.0.1:1080 -tls -cert /path/to/mycert
```

## üîß API

### –§—É–Ω–∫—Ü–∏–∏ –≤ `tlshelp.go`

```go
// tlsCacheDir() –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –∫–µ—à–∞
func tlsCacheDir() string

// getCachedTLS() –∑–∞–≥—Ä—É–∂–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏–∑ –∫–µ—à–∞ –∏–ª–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–π
func getCachedTLS(keysize int) (tls.Certificate, error)
```

### –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –∫–µ—à–∞

```
~/.revsocks-tls-cache/
‚îú‚îÄ‚îÄ server.crt        # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (644 –ø—Ä–∞–≤–∞ —Ö–æ—Ç—è –º–æ–∂–Ω–æ 0600)
‚îî‚îÄ‚îÄ server.key        # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á (0600 –ø—Ä–∞–≤–∞)
```

## üìä –°—Ç–∞—Ç—É—Å

- –í–µ—Ä—Å–∏—è: 2.6
- –î–∞—Ç–∞: 09.01.2026
- –°—Ç–∞—Ç—É—Å: ‚úÖ Production Ready
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: ‚úÖ –ö–æ–º–ø–∏–ª—è—Ü–∏—è —É—Å–ø–µ—à–Ω–∞, –±–µ–∑ linter –æ—à–∏–±–æ–∫
- –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: ‚úÖ –ü–æ–ª–Ω–∞—è

## üí° –ü—Ä–∏–º–µ—Ä—ã

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —á–∞—Å—Ç—ã–º–∏ —Ä–µ—Å—Ç–∞—Ä—Ç–∞–º–∏

```dockerfile
# Dockerfile
FROM golang:1.21
WORKDIR /app
COPY . .
RUN go build -o revsocks .

# Volume –¥–ª—è –∫–µ—à–∞
VOLUME /root/.revsocks-tls-cache

CMD ["./revsocks", "-listen", ":8443", "-socks", "127.0.0.1:1080", "-tls"]
```

–ü–µ—Ä–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: 500ms (–≥–µ–Ω–µ—Ä–∞—Ü–∏—è)
–û—Å—Ç–∞–ª—å–Ω—ã–µ: 1ms (–∫–µ—à –Ω–∞ volume)

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ü–µ—Ä–≤—ã–π –∑–∞–ø—É—Å–∫
$ time ./revsocks -listen :8443 -tls
# real    0m0.523s  # 523ms

# –í—Ç–æ—Ä–æ–π –∑–∞–ø—É—Å–∫
$ time ./revsocks -listen :8443 -tls
# real    0m0.024s  # 24ms - —É—Å–∫–æ—Ä–µ–Ω–∏–µ –≤ 20 —Ä–∞–∑!
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- –§–∞–π–ª—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ **0600** (–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É)
- –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ **0700** (–¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É)
- –ö–µ—à –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ home directory –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω)
- –ù–µ—Ç –ø–µ—Ä–µ–¥–∞—á–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ –ø–æ —Å–µ—Ç–∏

## ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- –ö–µ—à —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- –ï—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `-cert` —Ñ–ª–∞–≥ –∏–ª–∏ `-autocert` - –∫–µ—à –Ω–µ –∑–∞–¥–µ–π—Å—Ç–≤—É–µ—Ç—Å—è
- –ö–µ—à –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ä–∞–∑–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - —Ä–∞–∑–Ω—ã–µ –∫–µ—à–∏)
