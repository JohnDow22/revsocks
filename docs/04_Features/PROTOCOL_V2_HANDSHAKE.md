# Feature: Protocol v2 Handshake & Synchronization

**–í–µ—Ä—Å–∏—è:** 2.4-protocol-v2  
**–î–∞—Ç–∞:** 09.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready

---

## üìå –ü—Ä–æ–±–ª–µ–º–∞

Handshake v1 –∏–º–µ–ª —Ä—è–¥ –ø—Ä–æ–±–ª–µ–º:
- –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–æ —è–≤–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–∫–ª–∏–µ–Ω—Ç –ø–æ–ª–∞–≥–∞–ª—Å—è –Ω–∞ `time.Sleep(1s)` –∏ –¥–æ–ø—É—â–µ–Ω–∏–µ, —á—Ç–æ –≤—Å—ë –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ);
- `agentID` –ø–µ—Ä–µ–¥–∞–≤–∞–ª—Å—è –±–µ–∑ –¥–ª–∏–Ω—ã –∏ –±—ã–ª —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ TCP-—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏;
- –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±—ã–ª–∞ –Ω–µ—è–≤–Ω–æ–π, —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª —è–≤–Ω—ã–π –æ—Ç–∫–∞–∑;
- —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ –≤ DNS-–ø–æ–¥—Å–∏—Å—Ç–µ–º–µ (busy-loop –ø—Ä–∏ `session.IsClosed()`), –∞ —Ç–∞–∫–∂–µ –ø—Ä–æ–±–µ–ª—ã –≤ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `proxytimeout`).

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

–í–≤–µ–¥—ë–Ω **–ø—Ä–æ—Ç–æ–∫–æ–ª handshake v2** –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –Ω–∏–º —É–ª—É—á—à–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:

```text
Client ‚Üí Server:
  [password (64 bytes padded)]
  [agentID length (1 byte)]
  [agentID (0-255 bytes)]

Server ‚Üí Client:
  [status (2 bytes)]: "OK" –∏–ª–∏ "NO"
```

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- **Length-prefixed AgentID:** —Å–µ—Ä–≤–µ—Ä —Å–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–µ—Ç 1 –±–∞–π—Ç –¥–ª–∏–Ω—ã, –∑–∞—Ç–µ–º `agentID` —Å—Ç—Ä–æ–≥–æ —É–∫–∞–∑–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã;
- **ACK/NACK –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:** —Å–µ—Ä–≤–µ—Ä –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `"OK"` –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–µ –ø–∞—Ä–æ–ª—è –∏ `"NO"` –ø—Ä–∏ –æ—à–∏–±–∫–µ;
- **–£–¥–∞–ª—ë–Ω `Sleep(1s)` –∏–∑ –∫–ª–∏–µ–Ω—Ç–∞:** –≤–º–µ—Å—Ç–æ —Å–ª–µ–ø–æ–π –ø–∞—É–∑—ã –∫–ª–∏–µ–Ω—Ç –∂–¥—ë—Ç ACK —Å —Ç–∞–π–º–∞—É—Ç–æ–º (5 —Å–µ–∫—É–Ω–¥);
- **–Ø–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫:** –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –ø–∞—Ä–æ–ª–µ —Å–µ—Ä–≤–µ—Ä –ª–æ–≥–∏—Ä—É–µ—Ç `Authentication failed: password mismatch` –∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ;
- **DNS-fix:** –≤ `rdns.go` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `session.IsClosed()` –∏ backoff 5 —Å–µ–∫—É–Ω–¥, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å busy-loop.

---

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

–° —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Ñ–ª–∞–≥–∏ –Ω–µ –º–µ–Ω—è—é—Ç—Å—è ‚Äî –ø—Ä–æ—Ç–æ–∫–æ–ª v2 –ø—Ä–æ–∑—Ä–∞—á–µ–Ω –¥–ª—è CLI.

–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é:
- –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è—Ç—å –∏ —Å–µ—Ä–≤–µ—Ä, –∏ –∞–≥–µ–Ω—Ç—ã –¥–æ –≤–µ—Ä—Å–∏–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π v2;
- legacy-–∫–ª–∏–µ–Ω—Ç—ã (—Å—Ç–∞—Ä—ã–µ –±–∏–Ω–∞—Ä–Ω–∏–∫–∏) –º–æ–≥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å –Ω–æ–≤—ã–º —Å–µ—Ä–≤–µ—Ä–æ–º.

**–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**
- –ù–æ–≤—ã–π –∫–ª–∏–µ–Ω—Ç + –°—Ç–∞—Ä—ã–π —Å–µ—Ä–≤–µ—Ä ‚Üí —Ç–∞–π–º–∞—É—Ç, –∑–∞—Ç–µ–º reconnect (fallback);
- –°—Ç–∞—Ä—ã–π –∫–ª–∏–µ–Ω—Ç + –ù–æ–≤—ã–π —Å–µ—Ä–≤–µ—Ä ‚Üí –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–æ –ª–æ–º–∞–µ—Ç—Å—è handshake (–ø–æ—ç—Ç–æ–º—É –æ–±–Ω–æ–≤–ª—è—Ç—å –Ω—É–∂–Ω–æ –æ–±–∞).

---

## üîß –î–µ—Ç–∞–ª–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

- –û–±—â–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `yamux_config.go`:
  - `ProtocolVersion = 2`;
  - `PasswordSize = 64`;
  - `MaxAgentIDLength = 255`.
- –°–µ—Ä–≤–µ—Ä (`rserver.go`):
  - —á–∏—Ç–∞–µ—Ç –ø–∞—Ä–æ–ª—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –¥–ª–∏–Ω—ã;
  - —á–∏—Ç–∞–µ—Ç 1 –±–∞–π—Ç –¥–ª–∏–Ω—ã `agentID`, –∑–∞—Ç–µ–º —Å–∞–º `agentID`;
  - –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `"OK"` –∫–ª–∏–µ–Ω—Ç—É;
- –ö–ª–∏–µ–Ω—Ç (`rclient.go`):
  - –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª—å (64 –±–∞–π—Ç–∞, padded), –¥–ª–∏–Ω—É `agentID` –∏ —Å–∞–º `agentID`;
  - –∂–¥—ë—Ç `"OK"` —Å —Ç–∞–π–º–∞—É—Ç–æ–º;
  - –ø—Ä–∏ `"NO"` –∏–ª–∏ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–∞–π–º–∞—É—Ç–∞ ‚Äî –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ reconnect.

–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ:
- –í `main.go` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –∂—ë—Å—Ç–∫–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è `proxytimeout` (–≤ –æ–±–µ–∏—Ö –≤–µ—Ç–∫–∞—Ö ‚Äî listen/connect);
- –í `rdns.go` –∏—Å–ø—Ä–∞–≤–ª–µ–Ω busy-loop: –ø–µ—Ä–µ–¥ `Accept()` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è `session.IsClosed()`, –∞ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è backoff 5 —Å–µ–∫—É–Ω–¥.

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

Unit-—Ç–µ—Å—Ç—ã:
- `main_test.go` ‚Äî `parseProxyAuth` (10 —Ç–µ—Å—Ç-–∫–µ–π—Å–æ–≤, ~93% –ø–æ–∫—Ä—ã—Ç–∏—è —Ñ—É–Ω–∫—Ü–∏–∏);
- `rserver_test.go` ‚Äî `SessionManager`, `extractAgentIP` (100% –ø–æ–∫—Ä—ã—Ç–∏—è –ø–æ –∫–ª—é—á–µ–≤—ã–º –ø—É—Ç—è–º);
- `protocol_test.go` ‚Äî 4 –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–∞ handshake v2;

–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:
- –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —Å —Ñ–ª–∞–≥–æ–º `-race` (–Ω–µ—Ç –≥–æ–Ω–æ–∫ –≤ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–µ);
- –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ length-prefixed –ø—Ä–æ—Ç–æ–∫–æ–ª —É—Å—Ç–æ–π—á–∏–≤ –∫ TCP-—Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏.

---

## üìä –°—Ç–∞—Ç—É—Å

- **–í–µ—Ä—Å–∏—è:** 2.4-protocol-v2  
- **–î–∞—Ç–∞:** 09.01.2026  
- **–°—Ç–∞—Ç—É—Å:** ‚úÖ Production Ready  
- **–¢–µ—Å—Ç—ã:** 13/13 unit/integration —Ç–µ—Å—Ç–æ–≤ –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É –∏ —Å–≤—è–∑–∞–Ω–Ω—ã–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã

- CHANGELOG —Å–µ–∫—Ü–∏—è `2.4-protocol-v2`;
- –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ Session Lifecycle Manager: `SESSION_LIFECYCLE_MANAGER.md`;
- –ë–∞–≥—Ñ–∏–∫—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å –ø–æ—Ä—Ç-–ª–∏–∫/–≥–æ–Ω–∫–∞–º–∏: `2026_01_09_PORT_LEAK_RACE_CONDITION.md`.

