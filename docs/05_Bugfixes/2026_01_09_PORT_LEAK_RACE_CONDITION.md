# Bugfix: Port Leak and Session Race Condition

**–î–∞—Ç–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è:** 09.01.2026  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û

## üêõ –ü—Ä–æ–±–ª–µ–º–∞ (ISSUE)
1. **Port Leak:** –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è yamux, `net.Listener` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø—Ä–æ–¥–æ–ª–∂–∞–ª —Å–ª—É—à–∞—Ç—å –ø–æ—Ä—Ç, –Ω–æ –Ω–µ –º–æ–≥ –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤—ã–µ —Å—Ç—Ä–∏–º—ã (`session shutdown`), —á—Ç–æ –¥–µ–ª–∞–ª–æ –ø–æ—Ä—Ç –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã–º.
2. **Race Condition:** –ü—Ä–∏ –±—ã—Å—Ç—Ä–æ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∞–≥–µ–Ω—Ç–∞ –≥–æ—Ä—É—Ç–∏–Ω–∞ –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä–æ–π —Å–µ—Å—Å–∏–∏ –º–æ–≥–ª–∞ –∑–∞–∫—Ä—ã—Ç—å –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∫–ª—é—á (`agentID`) –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–Ω—Å—Ç–∞–Ω—Å–∞ —Å–µ—Å—Å–∏–∏.
3. **Busy Loop:** –ö–ª–∏–µ–Ω—Ç —É—Ö–æ–¥–∏–ª –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è CPU –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–µ—Å—Å–∏–∏ –≤ `Accept()`.

## üîç Root Cause
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º —Å–µ—Å—Å–∏–∏ `yamux.Session` –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º `net.Listener`.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ `agentID` –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ –º–∞–ø–µ —Å–µ—Å—Å–∏–π –±–µ–∑ —É—á–µ—Ç–∞ ¬´–ø–æ–∫–æ–ª–µ–Ω–∏—è¬ª —Å–µ—Å—Å–∏–∏.
- –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ `session.IsClosed()` –≤ —Ü–∏–∫–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å—Ç—Ä–∏–º–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ (SOLUTION)
1. **Generation Tokens:** –í —Å—Ç—Ä—É–∫—Ç—É—Ä—É `ManagedSession` –¥–æ–±–∞–≤–ª–µ–Ω —Å—á–µ—Ç—á–∏–∫ `generation`. –ö–∞–∂–¥–æ–µ –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID. –ö–æ–º–∞–Ω–¥–∞ `Unregister` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ generation —Å–æ–≤–ø–∞–¥–∞–µ—Ç.
2. **Context Cleanup:** –í —Ñ—É–Ω–∫—Ü–∏—é `listenForClients` –ø–µ—Ä–µ–¥–∞–Ω `context.CancelFunc`. –ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–µ—Å—Å–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –æ—Ç–º–µ–Ω—è–µ—Ç—Å—è, —á—Ç–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç listener.
3. **Improved Handshake:** –ß—Ç–µ–Ω–∏–µ `agentID` –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤ –±–ª–æ–∫ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–∞—Ä–æ–ª—è, –¥–æ–±–∞–≤–ª–µ–Ω —Ç–∞–π–º–∞—É—Ç 2—Å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å–µ—Ç—è—Ö.
4. **Yamux Sync:** –ù–∞—Å—Ç—Ä–æ–π–∫–∏ keepalive –≤—ã–Ω–µ—Å–µ–Ω—ã –≤ `yamux_config.go` –∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –≤ 30—Å –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –º–µ—Ä—Ç–≤—ã—Ö —É–∑–ª–æ–≤.

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (TEST_RESULTS)
- –ü—Ä–æ–≤–µ—Ä–∫–∞ CPU –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –ø—Ä–∏ kill —Å–µ—Ä–≤–µ—Ä–∞: 0%.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `netstat` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –ø–æ—Å–ª–µ reconnect: —Å—Ç–∞—Ä—ã–π –ø–æ—Ä—Ç –∑–∞–∫—Ä—ã—Ç, –Ω–æ–≤—ã–π (–∏–ª–∏ —Ç–æ—Ç –∂–µ) –∞–∫—Ç–∏–≤–µ–Ω.
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏: –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –¥–≤—É—Ö –∞–≥–µ–Ω—Ç–æ–≤ —Å –æ–¥–Ω–∏–º ID –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Å—Ç–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω (–ø–æ—Å–ª–µ–¥–Ω–∏–π).

## üìä –°—Ç–∞—Ç—É—Å
- Affected version: < 2.0
- Fixed in: 2.2-stable
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: üî¥ CRITICAL
