# PLAN UPDATE LOG: FEATURE_SLEEP_PLAN

## Дата обновления: 2026-01-09

## Причина обновления
План `FEATURE_SLEEP_PLAN` был создан до рефакторинга проекта RevSocks. 
Рефакторинг `2026-01-09_RevSocks_Refactor` разделил монолитный проект на:
- `cmd/agent/` - entry point агента
- `cmd/server/` - entry point сервера  
- `internal/{agent,server,common,transport}/` - изолированная бизнес-логика

## Критические изменения в плане

### 1. Целевые файлы обновлены

| Было (старая структура) | Стало (новая структура) |
|---|---|
| `rserver.go` | `internal/server/server.go` + `cmd/server/main.go` |
| `rclient.go` | `internal/agent/client.go` + `cmd/agent/main.go` |
| `agent_manager.go` (корень) | `internal/server/agent_manager.go` |
| `rserver_api.go` (корень) | `internal/server/api.go` |

### 2. Обновлённые документы плана

#### `00_PLAN_INDEX.md`
- ✅ Добавлено предупреждение о рефакторинге
- ✅ Обновлена матрица зависимостей (новые пути файлов)
- ✅ Обновлён Global Checklist (разделены задачи для cmd/ и internal/)

#### `01_Server_Architecture.md`
- ✅ Обновлены Target Files на новые пути
- ✅ Разделены задачи: создание в `internal/`, инициализация в `cmd/`
- ✅ Добавлены ссылки на `session.go` для понимания паттернов

#### `02_Client_Architecture.md`
- ✅ Обновлены Target Files на новые пути
- ✅ Разделены задачи: логика в `internal/agent/`, запуск в `cmd/agent/`
- ✅ Экспорт функций для использования в cmd/

#### `03_Admin_API_UI.md`
- ✅ Обновлены Target Files на новые пути
- ✅ Добавлен шаг инициализации Admin API в `cmd/server/main.go`

#### `04_Testing_Strategy.md`
- ✅ Обновлены пути к тестовым файлам (`internal/*/`)
- ✅ Добавлена ссылка на существующий E2E framework (`tests/e2e/`)
- ✅ Расширены сценарии API testing

#### `05_Next_Steps.md`
- ✅ Полностью переписан как Implementation Plan
- ✅ Разбит на 5 фаз с детальным breakdown
- ✅ Добавлена матрица зависимостей (Mermaid)
- ✅ Добавлен Risk Mitigation раздел

### 3. Новые преимущества после рефакторинга

**Изоляция логики:**
- AgentManager теперь в `internal/server/` - не видим из agent бинарника
- Меньший размер агента (нет серверного кода)

**Переиспользование кода:**
- `internal/common/` содержит общие утилиты (protocol, rand, version)
- Не нужно дублировать логику между агентом и сервером

**Упрощение тестирования:**
- Unit тесты в `internal/` изолированы от main.go
- E2E framework уже настроен под новую структуру

## Обратная совместимость

**Legacy бинарник сохранён:**
- `main.go` в корне всё ещё компилируется (для обратной совместимости)
- `Makefile` поддерживает как `make default` (новые бинарники), так и `make legacy`

**Протокол не изменён:**
- Handshake v3 - новая фича, но не breaking change
- Агенты без beacon mode продолжат работать в TUNNEL режиме

## Следующие шаги

1. ✅ План обновлён и проверен
2. ⏳ **Готовы к реализации Phase 1** (см. `05_Next_Steps.md`)
3. ⏳ Все задачи в Global Checklist готовы к выполнению

## Проверка консистентности

- ✅ Все пути к файлам обновлены
- ✅ Все TODO-списки разделены по модулям
- ✅ Все ссылки между документами корректны
- ✅ Roadmap согласован с новой архитектурой
- ✅ Время оценок пересчитано с учётом разделения cmd/internal

## Заключение

План `FEATURE_SLEEP_PLAN` полностью адаптирован под новую архитектуру проекта.
Готов к реализации без дополнительных изменений.
